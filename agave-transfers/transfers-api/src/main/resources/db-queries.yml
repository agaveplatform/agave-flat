create-transfertasks-table: |
  SET PROPERTY "sql.enforce_strict_size" TRUE;
  SET PROPERTY "sql.ignorecase" FALSE;

  DROP TABLE IF EXISTS transfertasks;

  CREATE TABLE IF NOT EXISTS transfertasks (
      "id" BIGINT IDENTITY PRIMARY KEY,
      "attempts" INTEGER DEFAULT 0 NOT NULL,
      "bytes_transferred" BIGINT DEFAULT 0 NOT NULL,
      "created" TIMESTAMP,
      "dest" VARCHAR(2048) NOT NULL,
      "end_time" TIMESTAMP,
      "event_id" VARCHAR(255),
      "last_updated" TIMESTAMP NOT NULL,
      "last_attempt" TIMESTAMP,
      "next_attempt" TIMESTAMP,
      "owner" VARCHAR(32) NOT NULL,
      "source" VARCHAR(2048) NOT NULL,
      "start_time" TIMESTAMP,
      "status" VARCHAR(16),
      "tenant_id" VARCHAR(128) NOT NULL,
      "total_size" BIGINT DEFAULT 0 NOT NULL,
      "transfer_rate" DOUBLE DEFAULT 0.0 NOT NULL,
      "parent_task" BIGINT,
      "root_task" BIGINT,
      "uuid" VARCHAR(64) NOT NULL,
      "total_files" BIGINT DEFAULT 0 NOT NULL,
      "total_skipped_files" BIGINT DEFAULT 0 NOT NULL,
      CONSTRAINT "fk_parent_task" FOREIGN KEY ("parent_task") REFERENCES transfertasks,
      CONSTRAINT "fk_root_task" FOREIGN KEY ("root_task") REFERENCES transfertasks,
      CONSTRAINT "uuid" UNIQUE ("uuid")
  );
get-transfertask: |
  SELECT * FROM transfertasks WHERE "uuid" = ? and "tenant_id" = ?
create-transfertask: |
  INSERT INTO TransferTasks
    ("attempts", "bytes_transferred", "created", "dest", "end_time", "event_id", "last_updated", "last_attempt", "next_attempt", "owner", "source", "start_time", "status", "tenant_id", "total_size", "transfer_rate", "parent_task", "root_task", "uuid", "total_files", "total_skipped_files")
  VALUES
    (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
save-transfertask: |
  UPDATE transfertasks
  SET "attempts" = ?,
    "bytes_transferred" = ?,
    "end_time" = ?,
    "start_time" = ?,
    "last_attempt" = ?,
    "next_attempt" = ?,
    "status" = ?,
    "total_size" = ?,
    "transfer_rate" = ?,
    "total_files" = ?,
    "total_skipped_files" = ?,
    "last_updated" = NOW()
  WHERE "uuid" = ? AND "tenant_id" = ?
all-transfertasks: |
  SELECT * FROM transfertasks WHERE "tenant_id" = ?
delete-transfertask: |
  DELETE FROM transfertasks WHERE "uuid" = ? AND "tenant_id" = ?
update-transfertask-status: |
  UPDATE transfertasks
  SET "status" = ?, "last_updated" = NOW()
  WHERE "uuid" = ? AND "tenant_id" = ?
all-transfertask-children-cancelled-or-completed: |
  SELECT count("id") AS "active_child_count"
  FROM transfertasks
  WHERE ("parent_task" = ?) AND "status" NOT IN ('COMPLETED','CANCELLED','FAILED') AND "tenant_id" = ?
all-active-root-transfertask-ids: |
  SELECT distinct "uuid", "tenant_id" 
  FROM transfertasks
  WHERE "root_task" is NULL and "parent_task" is NULL and "status" NOT IN ('COMPLETED','CANCELLED','FAILED')
single-not-canceled-or-completed: |
    SELECT count("id") AS "active_uuid"
    FROM transfertasks
    WHERE ("tenant_id" = ?) and ("uuid" = ?) AND "status" NOT IN ('COMPLETED','CANCELLED','FAILED') AND "tenant_id" = ?
all-children-canceled-or-completed: |
  SELECT count(id)
   FROM transfertasks
   WHERE ("parentTask" = ?) and status not in (('COMPLETED', 'CANCELLED','FAILED')
set-transfertask-cancelled-where-not-completed: |
  UPDATE transfertasks
  SET status = CANCELLED, lastUpdated = NOW()
  WHERE ("tenant_id" = ?) and ("uuid" = ?) and status not in ('COMPLETED', 'CANCELLED','FAILED')
get_transfertask_tree: |
  SELECT *
  FROM transfertasks
  WHERE parent_task = (SELECT parent_task from transfertasks where "uuid" = ? )
    AND status NOT IN (('COMPLETED', 'CANCELLED','FAILED')
  UNION
  SELECT *
  FROM transfertasks
  WHERE "uuid" = ?
  AND root_task IS NULL



















