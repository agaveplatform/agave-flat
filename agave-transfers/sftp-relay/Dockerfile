FROM agaveplatform/grpc-go:1.13

COPY agave-protos $GOPATH/src/github.com/agaveplatform/science-apis/agave-protos
COPY agave-transfers/sftp-relay $GOPATH/src/github.com/agaveplatform/science-apis/agave-transfers/sftp-relay

WORKDIR $GOPATH/src/github.com/agaveplatform/science-apis/agave-transfers/sftp-relay

RUN make clean && \
	make default

FROM alpine:latest
RUN apk --no-cache add ca-certificates openssl curl bash

LABEL maintainer="Agave Platform<help@agaveplatform.org>"
LABEL protoc_version="${PROTOC_VERSION}"
LABEL language="golang:1.11"
LABEL agave_platform=2.0
LABEL tooling=transfer,sftp,worker,put

WORKDIR /go/
COPY --from=0 /go/src/github.com/agaveplatform/science-apis/agave-transfers/sftp-relay/release/sftp-relay-linux-amd64 /usr/local/bin/agave-sftp

RUN \
    chmod +x /usr/local/bin/agave-sftp

ENTRYPOINT ["agave-sftp"]

CMD ["--help"]
